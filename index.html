<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u Loyalty ‚Äì CT 2026</title>

<style>
    * { box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Arial, sans-serif; 
        padding: 20px; 
        background: #f5f5f5;
        margin: 0;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h2 { 
        color: #333; 
        margin-bottom: 20px;
        font-size: 24px;
    }
    
    .search-box {
        margin-bottom: 20px;
    }
    
    .filter-box {
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .filter-chip input[type="radio"] {
        display: none;
    }
    
    .filter-chip label {
        display: inline-block;
        padding: 8px 16px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
    }
    
    .filter-chip input:checked + label {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
        font-weight: 600;
    }
    
    .province-select {
        width: 100%;
        max-width: 300px;
        padding: 10px 15px;
        border-radius: 8px;
        border: 2px solid #ddd;
    }
    
    input[type="text"] { 
        width: 100%;
        max-width: 500px;
        padding: 12px 16px; 
        font-size: 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
    }
    
    .stats {
        margin: 15px 0;
        padding: 12px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 14px;
        color: #1976d2;
    }
    
    .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
    }
    
    table { 
        border-collapse: collapse; 
        width: 100%; 
        font-size: 13px;
    }
    
    th, td { 
        border: 1px solid #ddd; 
        padding: 10px 8px;
        text-align: left;
    }
    
    th { 
        background: #4CAF50;
        color: white;
        position: sticky; 
        top: 0;
    }
    
    tr.approved-2026 { background: #c8e6c9; }
    tr.pending-2026 { background: #fff9c4; }
    tr.new-2025-only { background: #e1bee7; }
    tr.old-2025-no-2026 { background: #ffccbc; }
    tr.error-2026 { background: #ffcdd2; }
    
    .status-approved { color: #2e7d32; font-weight: 600; }
    .status-pending { color: #f57c00; font-weight: 600; }
    .status-error { color: #c62828; font-weight: 600; }
    
    .conflict-tag {
        display: inline-block;
        background: #ff5252;
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        cursor: pointer;
        margin-left: 5px;
        text-decoration: none;
    }
    
    .conflict-tag:hover { background: #d32f2f; }

    .clickable-status {
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
    }
    
    .modal-content {
        margin: 5% auto;
        padding: 20px;
        background: white;
        width: 90%;
        max-width: 800px;
        border-radius: 10px;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    
    .modal-body { text-align: center; padding: 20px; }
    .modal-image { max-width: 100%; max-height: 70vh; border-radius: 8px; }
    .close-btn { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
</style>
</head>

<body>

<div class="container">
    <h2>üîç Tra c·ª©u kh√°ch h√†ng Loyalty ‚Äì Ki·ªÉm tra CT 2026</h2>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Nh·∫≠p M√£ KH / T√™n kh√°ch h√†ng / SƒêT / T√™n TDV..." autocomplete="off">
    </div>
    
    <div class="filter-box">
        <div class="filter-group">
            <span class="filter-label">üîç Tr·∫°ng th√°i</span>
            <div class="filter-options">
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="all" id="status-all" checked>
                    <label for="status-all">üìã T·∫•t c·∫£</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="approved-2026" id="status-approved">
                    <label for="status-approved">‚úÖ ƒê√£ duy·ªát</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="pending-2026" id="status-pending">
                    <label for="status-pending">‚è≥ Ch·ªù duy·ªát</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="error-2026" id="status-error">
                    <label for="status-error">‚ùå B·ªã l·ªói</label>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <span class="filter-label">üìç T·ªânh th√†nh</span>
            <select class="province-select" id="provinceFilter">
                <option value="all">-- T·∫•t c·∫£ t·ªânh th√†nh --</option>
            </select>
        </div>
        
        <button style="margin-top:10px; cursor:pointer;" id="clearFilters">üîÑ X√≥a b·ªô l·ªçc</button>
    </div>
    
    <div id="stats" class="stats" style="display:none;"></div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>M√£ KH</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>T·ªânh</th>
                    <th>SƒêT</th>
                    <th>TDV</th>
                    <th>Tr·∫°ng th√°i 2025</th>
                    <th>Tr·∫°ng th√°i 2026</th>
                    <th>Ghi ch√∫</th>
                    <th>T·ªïng h·ª£p</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <tr><td colspan="9" style="text-align:center; padding:40px;">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">üñºÔ∏è H√¨nh ·∫£nh kh√°ch h√†ng</h3>
            <button class="close-btn" onclick="closeImageModal()">‚úï ƒê√≥ng</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
const NEW_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=new_data&tq=select%20*%20limit%2020000";
const OLD_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=original_data&tq=select%20*%20limit%2020000";
const UPDATE_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=bc_loyalty&tq=select%20*%20limit%2020000";

let uniqueData = [];
let isLoading = true;
let currentFilter = 'all';
let currentProvince = 'all';

/* ===== UTILS ===== */
function parseGViz(text) {
    const jsonText = text.substring(47, text.length - 2);
    return JSON.parse(jsonText);
}

function normalizeValue(val) {
    return val ? String(val).trim() : "";
}

function rowToObject(cols, row) {
    const obj = {};
    cols.forEach((col, i) => {
        const cell = row.c[i];
        obj[col.label] = cell ? (cell.f || cell.v || "") : "";
    });
    return obj;
}

function createUniqueKey(kh, sdt) {
    return `${normalizeValue(kh).toLowerCase().replace(/\s+/g, '')}|${normalizeValue(sdt).replace(/\s+/g, '')}`;
}

function parseDate(d) {
    if (!d) return new Date(0);
    const date = new Date(d);
    return isNaN(date.getTime()) ? new Date(0) : date;
}

/* ===== MODAL ===== */
function openImageModal(url, title) {
    if (!url) return;
    document.getElementById("modalTitle").innerText = "üñºÔ∏è " + title;
    document.getElementById("modalBody").innerHTML = '‚è≥ ƒêang t·∫£i...';
    document.getElementById("imageModal").style.display = "block";
    const img = new Image();
    img.className = "modal-image";
    img.src = url;
    img.onload = () => document.getElementById("modalBody").innerHTML = `<img src="${url}" class="modal-image">`;
    img.onerror = () => document.getElementById("modalBody").innerHTML = "‚ùå L·ªói t·∫£i ·∫£nh.";
}

function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }

/* ===== CORE LOGIC ===== */
async function loadData() {
    try {
        const [resNew, resOld, resUpdate] = await Promise.all([fetch(NEW_URL), fetch(OLD_URL), fetch(UPDATE_URL)]);
        const newJson = parseGViz(await resNew.text());
        const oldJson = parseGViz(await resOld.text());
        const updateJson = parseGViz(await resUpdate.text());

        // 1. X·ª≠ l√Ω bc_loyalty ƒë·ªÉ t√¨m "Main" v√† "K√Ω l·ªôn"
        const loyaltyMap = new Map(); // uniqueKey -> { main, conflicts: [] }
        
        updateJson.table.rows.forEach(row => {
            const obj = rowToObject(updateJson.table.cols, row);
            const key = createUniqueKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            if (!key || key === "|") return;

            const tdv = normalizeValue(obj["TDV"] || obj["T√™n TDV"] || "");
            const date = parseDate(obj["NGAY"]);
            const img = normalizeValue(obj["Link ·∫£nh"] || obj["H√¨nh ·∫£nh"] || obj[updateJson.table.cols[13]?.label]);
            
            const item = { ...obj, _date: date, _img: img, _tdv: tdv };

            if (!loyaltyMap.has(key)) {
                loyaltyMap.set(key, { main: item, conflicts: [] });
            } else {
                const group = loyaltyMap.get(key);
                if (tdv === group.main._tdv) {
                    // C√πng TDV -> l·∫•y b·∫£n m·ªõi nh·∫•t
                    if (date > group.main._date) group.main = item;
                } else {
                    // Kh√°c TDV -> t√≠nh l√† k√Ω l·ªôn
                    group.conflicts.push(item);
                }
            }
        });

        // 2. Gom t·∫•t c·∫£ kh√°ch h√†ng
        const finalMap = new Map();

        // N·∫°p data c≈©
        oldJson.table.rows.forEach(row => {
            const obj = rowToObject(oldJson.table.cols, row);
            const key = createUniqueKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            obj._source = 'original';
            finalMap.set(key, obj);
        });

        // N·∫°p data loyalty (ghi ƒë√® l√™n original)
        loyaltyMap.forEach((group, key) => {
            const obj = group.main;
            obj._source = 'bc_loyalty';
            obj._conflicts = group.conflicts;
            obj._imageUrl = group.main._img;
            finalMap.set(key, obj);
        });

        // N·∫°p data new_data (ƒê√£ duy·ªát/L·ªói - ∆Øu ti√™n cao nh·∫•t v·ªÅ tr·∫°ng th√°i)
        newJson.table.rows.forEach(row => {
            const obj = rowToObject(newJson.table.cols, row);
            const key = createUniqueKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const existing = finalMap.get(key);
            
            obj._source = 'new';
            // V·∫´n gi·ªØ l·∫°i link ·∫£nh v√† danh s√°ch k√Ω l·ªôn t·ª´ bc_loyalty n·∫øu c√≥
            if (existing) {
                obj._imageUrl = existing._imageUrl || "";
                obj._conflicts = existing._conflicts || [];
            }
            finalMap.set(key, obj);
        });

        uniqueData = Array.from(finalMap.values()).map(item => {
            const maKH = normalizeValue(item["M√£ KH"]);
            const kh = normalizeValue(item["KH"]);
            const sdt = normalizeValue(item["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const tdv = normalizeValue(item["TDV"]);
            const tinh = normalizeValue(item["T·ªânh"]);
            
            item._searchKey = `${maKH} ${kh} ${sdt} ${tdv}`.toLowerCase();
            item._tinh = tinh;
            return item;
        });

        // Render b·ªô l·ªçc t·ªânh
        const provinces = [...new Set(uniqueData.map(i => i._tinh))].filter(Boolean).sort();
        const pFilter = document.getElementById("provinceFilter");
        provinces.forEach(p => pFilter.add(new Option(p, p)));

        isLoading = false;
        render();
    } catch (e) {
        console.error(e);
        document.getElementById("tbody").innerHTML = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu.";
    }
}

function determineStatus(data) {
    const source = data._source;
    let res = { status: "unknown", d25: "ƒê√£ k√Ω 2025", d26: "Ch∆∞a k√Ω 2026", note: "", display: "‚ö†Ô∏è Ch∆∞a k√Ω 2026" };

    if (source === 'new') {
        const isOk = normalizeValue(data["ƒêƒÉng k√Ω th√†nh c√¥ng"]).toUpperCase() === "OK";
        res.status = isOk ? "approved-2026" : "error-2026";
        res.d26 = isOk ? "ƒê√£ k√Ω 2026 - ƒê√É DUY·ªÜT" : "ƒê√£ k√Ω 2026 - B·ªä L·ªñI";
        res.display = isOk ? "‚úÖ ƒê√£ duy·ªát" : "‚ùå B·ªä L·ªñI";
        res.note = [data["Note h√¨nh ·∫£nh"], data["Th√¥ng tin sai/thi·∫øu (n·∫øu c√≥)"]].filter(Boolean).join(" | ");
    } else if (source === 'bc_loyalty') {
        const form = normalizeValue(data["C·ªôt A"] || data["Form"] || "");
        if (form.includes("FM2501")) {
            res.status = "new-2025-only";
            res.d25 = "M·ªõi k√Ω 2025";
            res.display = "üÜï M·ªõi k√Ω 2025";
        } else {
            res.status = "pending-2026";
            res.d26 = "ƒê√£ k√Ω 2026 - CH·ªú DUY·ªÜT";
            res.display = "‚è≥ Ch·ªù duy·ªát";
        }
    } else {
        res.status = "old-2025-no-2026";
    }
    return res;
}

function render() {
    const kw = document.getElementById("searchInput").value.toLowerCase().trim();
    const tbody = document.getElementById("tbody");
    const statsDiv = document.getElementById("stats");
    
    if (isLoading) return;
    if (!kw && currentFilter === 'all' && currentProvince === 'all') {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px;">üîç Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm...</td></tr>';
        return;
    }

    let count = 0;
    const fragment = document.createDocumentFragment();

    uniqueData.forEach(item => {
        if (kw && !item._searchKey.includes(kw)) return;
        if (currentProvince !== 'all' && item._tinh !== currentProvince) return;
        
        const info = determineStatus(item);
        if (currentFilter !== 'all' && info.status !== currentFilter) return;

        const tr = document.createElement("tr");
        tr.className = info.status;

        // X·ª≠ l√Ω ghi ch√∫ k√Ω l·ªôn
        let conflictHtml = "";
        if (item._conflicts && item._conflicts.length > 0) {
            item._conflicts.forEach(c => {
                conflictHtml += `<span class="conflict-tag" onclick="openImageModal('${c._img}', '·∫¢nh k√Ω l·ªôn c·ªßa ${c._tdv}')">${c._tdv} k√Ω l·ªôn</span> `;
            });
        }

        const imgUrl = item._imageUrl || "";
        const statusClass = imgUrl ? "clickable-status" : "";
        const statusOnClick = imgUrl ? `onclick="openImageModal('${imgUrl}', '·∫¢nh c·ªßa ${item["KH"]}')"` : "";

        tr.innerHTML = `
            <td>${item["M√£ KH"] || ""}</td>
            <td>${item["KH"] || ""}</td>
            <td>${item._tinh || ""}</td>
            <td>${item["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"] || ""}</td>
            <td>${item["TDV"] || ""}</td>
            <td>${info.d25}</td>
            <td>${info.d26}</td>
            <td>${info.note} ${conflictHtml}</td>
            <td class="${statusClass} status-${info.status}" ${statusOnClick}>${info.display} ${imgUrl ? 'üñºÔ∏è' : ''}</td>
        `;
        fragment.appendChild(tr);
        count++;
    });

    tbody.innerHTML = "";
    tbody.appendChild(fragment);
    statsDiv.innerHTML = `üìä T√¨m th·∫•y <strong>${count}</strong> k·∫øt qu·∫£.`;
    statsDiv.style.display = "block";
}

/* ===== EVENTS ===== */
document.getElementById("searchInput").addEventListener("input", render);
document.querySelectorAll('input[name="statusFilter"]').forEach(r => r.addEventListener('change', e => { currentFilter = e.target.value; render(); }));
document.getElementById("provinceFilter").addEventListener('change', e => { currentProvince = e.target.value; render(); });
document.getElementById("clearFilters").addEventListener('click', () => {
    document.getElementById("searchInput").value = "";
    document.getElementById("status-all").checked = true;
    currentFilter = 'all';
    document.getElementById("provinceFilter").value = 'all';
    currentProvince = 'all';
    render();
});

loadData();
</script>
</body>
</html>
