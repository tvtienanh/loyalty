<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u Loyalty ‚Äì CT 2026</title>

<style>
    /* GI·ªÆ NGUY√äN TO√ÄN B·ªò CSS G·ªêC C·ª¶A B·∫†N */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; padding: 20px; background: #f5f5f5; margin: 0; }
    .container { max-width: 1600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #333; margin-bottom: 20px; font-size: 24px; }
    .search-box { margin-bottom: 20px; }
    .filter-box { margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    .filter-group { margin-bottom: 15px; }
    .filter-label { display: block; font-weight: 600; color: #2c3e50; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    .filter-options { display: flex; flex-wrap: wrap; gap: 10px; }
    .filter-chip input[type="radio"] { display: none; }
    .filter-chip label { display: inline-block; padding: 8px 16px; background: white; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; }
    .filter-chip label:hover { border-color: #4CAF50; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2); }
    .filter-chip input:checked + label { background: #4CAF50; color: white; border-color: #4CAF50; font-weight: 600; }
    .province-select { width: 100%; max-width: 300px; padding: 10px 15px; font-size: 14px; border: 2px solid #ddd; border-radius: 8px; }
    .clear-filters { margin-top: 15px; padding: 8px 20px; background: #ff5252; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; }
    input[type="text"] { width: 100%; max-width: 500px; padding: 12px 16px; font-size: 15px; border: 2px solid #ddd; border-radius: 6px; }
    .stats { margin: 15px 0; padding: 12px; background: #e3f2fd; border-radius: 6px; font-size: 14px; color: #1976d2; }
    .table-wrapper { overflow-x: auto; margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; background: #fff; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 10px 8px; text-align: left; }
    th { background: #4CAF50; color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    tr.approved-2026 { background: #c8e6c9; }
    tr.pending-2026 { background: #fff9c4; }
    tr.new-2025-only { background: #e1bee7; }
    tr.old-2025-no-2026 { background: #ffccbc; }
    tr.error-2026 { background: #ffcdd2; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { position: relative; margin: 5% auto; padding: 20px; background: white; width: 90%; max-width: 800px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #4CAF50; }
    .close-btn { background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .modal-body { text-align: center; }
    .modal-image { max-width: 100%; max-height: 70vh; border-radius: 8px; }
    .clickable-status { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    /* Style m·ªõi cho b√°o tr√πng */
    .conflict-tag { color: #d32f2f; font-weight: bold; cursor: pointer; text-decoration: underline; margin-left: 5px; }
</style>
</head>

<body>
<div class="container">
    <h2>üîç Tra c·ª©u Loyalty ‚Äì Ki·ªÉm tra CT 2026</h2>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Nh·∫≠p M√£ KH / T√™n kh√°ch h√†ng / SƒêT / T√™n TDV...">
    </div>
    <div class="filter-box">
        <div class="filter-group">
            <span class="filter-label">üîç Tr·∫°ng th√°i</span>
            <div class="filter-options">
                <div class="filter-chip"><input type="radio" name="statusFilter" value="all" id="status-all" checked><label for="status-all">üìã T·∫•t c·∫£</label></div>
                <div class="filter-chip"><input type="radio" name="statusFilter" value="approved-2026" id="status-approved"><label for="status-approved">‚úÖ ƒê√£ duy·ªát</label></div>
                <div class="filter-chip"><input type="radio" name="statusFilter" value="pending-2026" id="status-pending"><label for="status-pending">‚è≥ Ch·ªù duy·ªát</label></div>
                <div class="filter-chip"><input type="radio" name="statusFilter" value="error-2026" id="status-error"><label for="status-error">‚ùå B·ªã l·ªói</label></div>
                <div class="filter-chip"><input type="radio" name="statusFilter" value="new-2025-only" id="status-new-2025"><label for="status-new-2025">üÜï M·ªõi k√Ω 2025</label></div>
                <div class="filter-chip"><input type="radio" name="statusFilter" value="old-2025-no-2026" id="status-old"><label for="status-old">‚ö†Ô∏è Ch∆∞a k√Ω 2026</label></div>
            </div>
        </div>
        <div class="filter-group">
            <span class="filter-label">üìç T·ªânh th√†nh</span>
            <select class="province-select" id="provinceFilter"><option value="all">-- T·∫•t c·∫£ t·ªânh th√†nh --</option></select>
        </div>
        <button class="clear-filters" id="clearFilters">üîÑ X√≥a b·ªô l·ªçc</button>
    </div>
    <div id="stats" class="stats" style="display:none;"></div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>M√£ KH</th><th>Kh√°ch h√†ng</th><th>T·ªânh</th><th>SƒêT</th><th>TDV</th><th>Tr·∫°ng th√°i 2025</th><th>Tr·∫°ng th√°i 2026</th><th>Ghi ch√∫</th><th>T·ªïng h·ª£p</th>
                </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="9" class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>üñºÔ∏è H√¨nh ·∫£nh</h3><button class="close-btn" onclick="closeImageModal()">‚úï ƒê√≥ng</button></div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
const NEW_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=new_data&tq=select%20*%20limit%2020000";
const OLD_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=original_data&tq=select%20*%20limit%2020000";
const UPDATE_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=bc_loyalty&tq=select%20*%20limit%2020000";

let uniqueData = [];
let isLoading = true;
let currentFilter = 'all';
let currentProvince = 'all';

function parseGViz(text) { return JSON.parse(text.substring(47, text.length - 2)); }
function normalizeValue(val) { return val ? String(val).trim() : ""; }
function rowToObject(cols, row) {
    const obj = {};
    cols.forEach((col, i) => {
        const cell = row.c[i];
        obj[col.label] = cell ? (cell.f || cell.v || "") : "";
    });
    return obj;
}
function createKey(kh, sdt) { 
    return `${normalizeValue(kh).toLowerCase().replace(/\s+/g, '')}|${normalizeValue(sdt).replace(/\s+/g, '')}`; 
}

function openImageModal(url, title) {
    if (!url) return;
    const modal = document.getElementById("imageModal");
    const modalBody = document.getElementById("modalBody");
    modalBody.innerHTML = '‚è≥ ƒêang t·∫£i...';
    modal.style.display = "block";
    const img = new Image();
    img.className = "modal-image";
    img.onload = () => { modalBody.innerHTML = ''; modalBody.appendChild(img); };
    img.src = url;
}
function closeImageModal() { document.getElementById("imageModal").style.display = "none"; }

async function loadData() {
    try {
        const [resN, resO, resU] = await Promise.all([fetch(NEW_URL), fetch(OLD_URL), fetch(UPDATE_URL)]);
        const newJ = parseGViz(await resN.text()), oldJ = parseGViz(await resO.text()), updateJ = parseGViz(await resU.text());

        // 1. X·ª≠ l√Ω bc_loyalty: Check tr√πng & L·ªçc ·∫£nh (Ch·ªâ l·∫•y FM2601)
        const loyaltyLookup = new Map();
        updateJ.table.rows.forEach(row => {
            const obj = rowToObject(updateJ.table.cols, row);
            const key = createKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            if (!key || key === "|") return;

            const tdv = normalizeValue(obj["TDV"] || obj["T√™n TDV g·ª≠i code"] || "");
            const form = normalizeValue(obj["C·ªôt A"] || obj["Form"] || "");
            const img = form.includes("FM2601") ? normalizeValue(obj["Link ·∫£nh"] || obj["H√¨nh ·∫£nh"] || obj[updateJ.table.cols[13]?.label]) : "";
            const ngay = obj["NGAY"] ? new Date(obj["NGAY"]) : new Date(0);

            if (!loyaltyLookup.has(key)) {
                loyaltyLookup.set(key, { main: obj, img: img, tdv: tdv, date: ngay, form: form, conflicts: [] });
            } else {
                let entry = loyaltyLookup.get(key);
                if (tdv === entry.tdv) {
                    if (ngay > entry.date) { entry.main = obj; entry.date = ngay; entry.img = img; entry.form = form; }
                } else {
                    entry.conflicts.push({ tdv: tdv, img: img });
                }
            }
        });

        const masterMap = new Map();
        // A. Data c≈©
        oldJ.table.rows.forEach(row => {
            const obj = rowToObject(oldJ.table.cols, row);
            const key = createKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            obj._source = 'original';
            masterMap.set(key, obj);
        });
        // B. Ghi ƒë√® bc_loyalty
        loyaltyLookup.forEach((v, k) => {
            let obj = v.main;
            obj._source = 'bc_loyalty';
            obj._img = v.img; obj._conflicts = v.conflicts; obj._form = v.form;
            masterMap.set(k, obj);
        });
        // C. Ghi ƒë√® new_data
        newJ.table.rows.forEach(row => {
            const obj = rowToObject(newJ.table.cols, row);
            const key = createKey(obj["KH"], obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const l = loyaltyLookup.get(key);
            obj._source = 'new';
            obj._img = l ? l.img : ""; obj._conflicts = l ? l.conflicts : [];
            masterMap.set(key, obj);
        });

        uniqueData = Array.from(masterMap.values()).map(item => {
            const tinh = normalizeValue(item["T·ªânh"]);
            if (tinh && !Array.from(document.getElementById("provinceFilter").options).some(o => o.value === tinh)) {
                document.getElementById("provinceFilter").add(new Option(tinh, tinh));
            }
            item._search = `${item["M√£ KH"]} ${item["KH"]} ${item["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]} ${item["TDV"]}`.toLowerCase();
            return item;
        });

        isLoading = false; render();
    } catch (e) { console.error(e); }
}

function determineStatus(data) {
    if (data._source === 'new') {
        const ok = normalizeValue(data["ƒêƒÉng k√Ω th√†nh c√¥ng"]).toUpperCase() === "OK";
        return {
            cls: ok ? "approved-2026" : "error-2026",
            d26: ok ? "ƒê√£ k√Ω 2026 - ƒê√É DUY·ªÜT" : "ƒê√£ k√Ω 2026 - B·ªä L·ªñI",
            display: ok ? "‚úÖ ƒê√£ duy·ªát" : "‚ùå B·ªã l·ªói",
            note: [data["Note h√¨nh ·∫£nh"], data["Th√¥ng tin sai/thi·∫øu (n·∫øu c√≥)"]].filter(n => n).join(" | ")
        };
    } else if (data._source === 'bc_loyalty') {
        const is25 = data._form.includes("FM2501");
        return {
            cls: is25 ? "new-2025-only" : "pending-2026",
            d26: is25 ? "Ch∆∞a k√Ω 2026" : "ƒê√£ k√Ω 2026 - CH·ªú DUY·ªÜT",
            display: is25 ? "üÜï M·ªõi k√Ω 2025" : "‚è≥ Ch·ªù duy·ªát",
            note: ""
        };
    }
    return { cls: "old-2025-no-2026", d26: "Ch∆∞a k√Ω 2026", display: "‚ö†Ô∏è Ch∆∞a k√Ω 2026", note: "" };
}

function render() {
    const tbody = document.getElementById("tbody");
    if (isLoading) return;
    const kw = document.getElementById("searchInput").value.toLowerCase().trim();
    const fragment = document.createDocumentFragment();

    uniqueData.forEach(item => {
        if (kw && !item._search.includes(kw)) return;
        if (currentProvince !== 'all' && normalizeValue(item["T·ªânh"]) !== currentProvince) return;
        const info = determineStatus(item);
        if (currentFilter !== 'all' && info.cls !== currentFilter) return;

        let confHtml = "";
        if (item._conflicts?.length > 0) {
            item._conflicts.forEach(c => {
                if (c.img) confHtml += `<span class="conflict-tag" onclick="openImageModal('${c.img}', '${c.tdv} k√Ω l·ªôn')">${c.tdv} k√Ω l·ªôn</span> `;
                else confHtml += `<span style="color:#666; margin-left:5px;">${c.tdv} k√Ω l·ªôn</span> `;
            });
        }

        const tr = document.createElement("tr");
        tr.className = info.cls;
        tr.innerHTML = `
            <td>${item["M√£ KH"] || ""}</td><td>${item["KH"] || ""}</td><td>${item["T·ªânh"] || ""}</td><td>${item["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"] || ""}</td><td>${item["TDV"] || ""}</td>
            <td>${info.cls === 'new-2025-only' ? 'M·ªõi k√Ω 2025' : 'ƒê√£ k√Ω 2025'}</td><td>${info.d26}</td><td>${info.note} ${confHtml}</td>
            <td class="${item._img ? 'clickable-status' : ''}" onclick="openImageModal('${item._img}', '${item["KH"]}')">${info.display} ${item._img ? 'üñºÔ∏è' : ''}</td>
        `;
        fragment.appendChild(tr);
    });
    tbody.innerHTML = ""; tbody.appendChild(fragment);
}

document.getElementById("searchInput").addEventListener("input", render);
document.querySelectorAll('input[name="statusFilter"]').forEach(r => r.addEventListener('change', e => { currentFilter = e.target.value; render(); }));
document.getElementById("provinceFilter").addEventListener('change', e => { currentProvince = e.target.value; render(); });
document.getElementById("clearFilters").addEventListener('click', () => { location.reload(); });
loadData();
</script>
</body>
</html>
