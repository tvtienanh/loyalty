<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra c·ª©u Loyalty ‚Äì CT 2026</title>

<style>
    * { box-sizing: border-box; }
    body { 
        font-family: 'Segoe UI', Tahoma, Arial, sans-serif; 
        padding: 20px; 
        background: #f5f5f5;
        margin: 0;
    }
    
    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h2 { 
        color: #333; 
        margin-bottom: 10px;
        font-size: 24px;
    }
    
    .update-time {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
        font-style: italic;
    }
    
    .search-box {
        margin-bottom: 20px;
    }
    
    .filter-box {
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group:last-child {
        margin-bottom: 0;
    }
    
    .filter-label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .filter-chip {
        position: relative;
    }
    
    .filter-chip input[type="radio"],
    .filter-chip input[type="checkbox"] {
        display: none;
    }
    
    .filter-chip label {
        display: inline-block;
        padding: 8px 16px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s ease;
        user-select: none;
    }
    
    .filter-chip label:hover {
        border-color: #4CAF50;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2);
    }
    
    .filter-chip input:checked + label {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
        font-weight: 600;
    }
    
    .province-select {
        width: 100%;
        max-width: 300px;
        padding: 10px 15px;
        font-size: 14px;
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
    }
    
    .province-select:focus {
        outline: none;
        border-color: #4CAF50;
    }
    
    .clear-filters {
        margin-top: 15px;
        padding: 8px 20px;
        background: #ff5252;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .clear-filters:hover {
        background: #ff1744;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 82, 82, 0.3);
    }
    
    .clear-cache {
        margin-top: 15px;
        margin-left: 10px;
        padding: 8px 20px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .clear-cache:hover {
        background: #1976D2;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
    }
    
    input[type="text"] { 
        width: 100%;
        max-width: 500px;
        padding: 12px 16px; 
        font-size: 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
        transition: border-color 0.3s;
    }
    
    input[type="text"]:focus {
        outline: none;
        border-color: #4CAF50;
    }
    
    .stats {
        margin: 15px 0;
        padding: 12px;
        background: #e3f2fd;
        border-radius: 6px;
        font-size: 14px;
        color: #1976d2;
    }
    
    .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
    }
    
    table { 
        border-collapse: collapse; 
        width: 100%; 
        background: #fff;
        font-size: 13px;
    }
    
    th, td { 
        border: 1px solid #ddd; 
        padding: 10px 8px;
        text-align: left;
    }
    
    th { 
        background: #4CAF50;
        color: white;
        font-weight: 600;
        position: sticky; 
        top: 0;
        z-index: 10;
    }
    
    tr.approved-2026 { background: #c8e6c9; }
    tr.pending-2026 { background: #fff9c4; }
    tr.new-2025-only { background: #e1bee7; }
    tr.old-2025-no-2026 { background: #ffccbc; }
    tr.error-2026 { background: #ffcdd2; }
    
    tr:hover {
        opacity: 0.8;
    }
    
    .status-approved {
        color: #2e7d32;
        font-weight: 600;
    }
    
    .status-pending {
        color: #f57c00;
        font-weight: 600;
    }
    
    .status-new-2025 {
        color: #7b1fa2;
        font-weight: 600;
    }
    
    .status-old-no-2026 {
        color: #e64a19;
        font-weight: 600;
    }
    
    .status-error {
        color: #c62828;
        font-weight: 600;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }
    
    .no-results {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        position: relative;
        margin: 5% auto;
        padding: 20px;
        background: white;
        width: 90%;
        max-width: 800px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideDown 0.3s;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #4CAF50;
    }
    
    .modal-header h3 {
        margin: 0;
        color: #333;
        font-size: 20px;
    }
    
    .close-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background 0.3s;
    }
    
    .close-btn:hover {
        background: #d32f2f;
    }
    
    .modal-body {
        text-align: center;
    }
    
    .modal-image {
        max-width: 100%;
        max-height: 70vh;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .image-loading {
        padding: 40px;
        color: #666;
    }
    
    .image-error {
        padding: 40px;
        color: #f44336;
    }
    
    .clickable-status {
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
    }
    
    .clickable-status:hover {
        opacity: 0.7;
    }
    
    .duplicate-warning {
        color: #e65100;
        font-size: 11px;
        cursor: pointer;
        text-decoration: underline;
        display: block;
        margin-top: 5px;
    }
    
    .duplicate-warning:hover {
        color: #bf360c;
    }
    
    .upload-history {
        color: #0277bd;
        font-size: 11px;
        cursor: pointer;
        text-decoration: underline;
        display: block;
        margin-top: 5px;
    }
    
    .upload-history:hover {
        color: #01579b;
    }
</style>
</head>

<body>

<div class="container">
    <h2>üîç Tra c·ª©u kh√°ch h√†ng Loyalty ‚Äì Ki·ªÉm tra CT 2026</h2>
    <div class="update-time" id="updateTime"></div>
    
    <div class="search-box">
        <input 
            type="text"
            id="searchInput" 
            placeholder="Nh·∫≠p M√£ KH / T√™n kh√°ch h√†ng / SƒêT / T√™n TDV ƒë·ªÉ t√¨m ki·∫øm..."
            autocomplete="off"
        >
    </div>
    
    <div class="filter-box">
        <div class="filter-group">
            <span class="filter-label">üìä Tr·∫°ng th√°i</span>
            <div class="filter-options">
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="all" id="status-all" checked>
                    <label for="status-all">üìã T·∫•t c·∫£</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="approved-2026" id="status-approved">
                    <label for="status-approved">‚úÖ ƒê√£ k√Ω 2026 & ƒê√£ duy·ªát</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="pending-2026" id="status-pending">
                    <label for="status-pending">‚è≥ ƒê√£ k√Ω 2026 ch∆∞a duy·ªát</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="error-2026" id="status-error">
                    <label for="status-error">‚ùå ƒê√£ k√Ω 2026 b·ªã l·ªói</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="new-2025-only" id="status-new-2025">
                    <label for="status-new-2025">üÜï M·ªõi k√Ω 2025 ch∆∞a k√Ω 2026</label>
                </div>
                <div class="filter-chip">
                    <input type="radio" name="statusFilter" value="old-2025-no-2026" id="status-old">
                    <label for="status-old">‚ö†Ô∏è ƒê√£ k√Ω 2025 ch∆∞a k√Ω 2026</label>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <span class="filter-label">üìç T·ªânh th√†nh</span>
            <select class="province-select" id="provinceFilter">
                <option value="all">-- T·∫•t c·∫£ t·ªânh th√†nh --</option>
            </select>
        </div>
        
        <button class="clear-filters" id="clearFilters">üîÑ X√≥a t·∫•t c·∫£ b·ªô l·ªçc</button>
        <button class="clear-cache" id="clearCache">üîÑ T·∫£i l·∫°i d·ªØ li·ªáu</button>
    </div>
    
    <div id="stats" class="stats" style="display:none;"></div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>M√£ KH</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>T·ªânh</th>
                    <th>SƒêT</th>
                    <th>TDV</th>
                    <th>Tr·∫°ng th√°i 2025</th>
                    <th>Tr·∫°ng th√°i 2026</th>
                    <th>Ghi ch√∫</th>
                    <th>T·ªïng h·ª£p</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <tr>
                    <td colspan="9" class="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üñºÔ∏è H√¨nh ·∫£nh kh√°ch h√†ng</h3>
            <button class="close-btn" onclick="closeImageModal()">‚úï ƒê√≥ng</button>
        </div>
        <div class="modal-body" id="modalBody">
            <div class="image-loading">‚è≥ ƒêang t·∫£i h√¨nh ·∫£nh...</div>
        </div>
    </div>
</div>

<script>
const NEW_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=new_data&tq=select%20*%20limit%2020000";
const OLD_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=original_data&tq=select%20*%20limit%2020000";
const UPDATE_URL = "https://docs.google.com/spreadsheets/d/14dZ70xuUlYskJHGLfF4dI_lY_V8vsqJfAJ-Dlo_DdrU/gviz/tq?tqx=out:json&sheet=bc_loyalty&tq=select%20*%20limit%2020000";

const MAX_RENDER = 10000;

let uniqueData = [];
let debounceTimer;
let isLoading = true;
let currentFilter = 'all';
let currentProvince = 'all';
let allProvinces = new Set();

function openImageModal(imageUrl, customerName) {
    const modal = document.getElementById("imageModal");
    const modalBody = document.getElementById("modalBody");
    
    if (!imageUrl) {
        modalBody.innerHTML = '<div class="image-error">‚ùå Kh√¥ng c√≥ h√¨nh ·∫£nh</div>';
        modal.style.display = "block";
        return;
    }
    
    modalBody.innerHTML = '<div class="image-loading">‚è≥ ƒêang t·∫£i h√¨nh ·∫£nh...</div>';
    modal.style.display = "block";
    
    const img = new Image();
    img.className = "modal-image";
    img.onload = function() {
        modalBody.innerHTML = '';
        modalBody.appendChild(img);
    };
    img.onerror = function() {
        modalBody.innerHTML = '<div class="image-error">‚ùå Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh<br><small>' + imageUrl + '</small></div>';
    };
    img.src = imageUrl;
}

function closeImageModal() {
    const modal = document.getElementById("imageModal");
    modal.style.display = "none";
}

window.onclick = function(event) {
    const modal = document.getElementById("imageModal");
    if (event.target === modal) {
        closeImageModal();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});

function parseGViz(text) {
    const jsonText = text.substring(47, text.length - 2);
    return JSON.parse(jsonText);
}

function normalizeValue(val) {
    if (val === null || val === undefined || val === "") return "";
    return String(val).trim();
}

function rowToObject(cols, row) {
    const obj = {};
    cols.forEach((col, i) => {
        const cellValue = row.c[i];
        let value = "";
        
        if (cellValue !== null && cellValue !== undefined) {
            if (cellValue.f !== null && cellValue.f !== undefined) {
                value = cellValue.f;
            } else if (cellValue.v !== null && cellValue.v !== undefined) {
                value = cellValue.v;
            }
        }
        
        obj[col.label] = value;
    });
    return obj;
}

function createUniqueKey(kh, sdt) {
    const khNorm = normalizeValue(kh).toLowerCase().replace(/\s+/g, '');
    const sdtNorm = normalizeValue(sdt).replace(/\s+/g, '');
    return `${khNorm}|${sdtNorm}`;
}

function parseNgayColumn(ngayStr) {
    if (!ngayStr) return null;
    try {
        const str = normalizeValue(ngayStr);
        if (!str) return null;
        
        // Parse format: YYYY-MM-DD HH:mm:ss.SSS or YYYY/MM/DD HH:mm:ss.SSS
        const normalized = str.replace(/\//g, '-');
        const date = new Date(normalized);
        
        if (isNaN(date.getTime())) return null;
        return date;
    } catch (e) {
        return null;
    }
}

function formatUpdateTime(date) {
    if (!date) return "";
    
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    
    let hours = date.getHours();
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    const hoursStr = String(hours).padStart(2, '0');
    
    return `${day}/${month}/${year} - ${hoursStr}:${minutes} ${ampm}`;
}

function extractImageUrl(htmlString) {
    if (!htmlString) return "";
    
    const match = htmlString.match(/src="([^"]+)"/);
    if (match && match[1]) {
        return match[1];
    }
    
    if (htmlString.startsWith('http')) {
        return htmlString;
    }
    
    return "";
}

function isSameTeam(tdv1, tdv2) {
    const t1 = normalizeValue(tdv1).toLowerCase();
    const t2 = normalizeValue(tdv2).toLowerCase();
    
    const hasTele1 = t1.includes('tele');
    const hasTele2 = t2.includes('tele');
    
    // Both have "Tele" or both don't have "Tele" = same team
    return hasTele1 === hasTele2;
}

function isWithin7Days(date) {
    if (!date) return false;
    const now = new Date();
    const diffTime = now - date;
    const diffDays = diffTime / (1000 * 60 * 60 * 24);
    return diffDays <= 7;
}

function determineCustomerStatus(data, allRecords) {
    const source = data._source;
    
    if (source === 'new') {
        const dangKy = normalizeValue(data["ƒêƒÉng k√Ω th√†nh c√¥ng"]).toUpperCase();
        const noteHinhAnh = normalizeValue(data["Note h√¨nh ·∫£nh"]);
        const thongTinSai = normalizeValue(data["Th√¥ng tin sai/thi·∫øu (n·∫øu c√≥)"]);
        
        if (dangKy === "OK") {
            return {
                status: "approved-2026",
                display: "‚úÖ ƒê√£ k√Ω 2026 & ƒê√£ duy·ªát",
                status2025: "ƒê√£ k√Ω 2025",
                status2026: "ƒê√£ k√Ω 2026 - ƒê√É DUY·ªÜT",
                note: "",
                imageUrl: data._imageUrl || ""
            };
        } else {
            return {
                status: "error-2026",
                display: "‚ùå ƒê√£ k√Ω 2026 b·ªã l·ªói",
                status2025: "ƒê√£ k√Ω 2025",
                status2026: "ƒê√£ k√Ω 2026 - B·ªä L·ªñI",
                note: [noteHinhAnh, thongTinSai].filter(n => n).join(" | "),
                imageUrl: data._imageUrl || ""
            };
        }
    } else if (source === 'bc_loyalty') {
        const formType = normalizeValue(data["C·ªôt A"] || data["Form"] || "");
        
        if (formType.includes("FM2601_Upload Thoa thuan CT Vung tin gang ket 2026")) {
            return {
                status: "pending-2026",
                display: "‚è≥ ƒê√£ k√Ω 2026 ch∆∞a duy·ªát",
                status2025: "ƒê√£ k√Ω 2025",
                status2026: "ƒê√£ k√Ω 2026 - CH∆ØA DUY·ªÜT",
                note: "",
                imageUrl: data._imageUrl || ""
            };
        } else if (formType.includes("FM2501_Upload Thoa thuan CT Vung tin gang ket 2025")) {
            if (data._ngayDate && isWithin7Days(data._ngayDate)) {
                return {
                    status: "new-2025-only",
                    display: "üÜï M·ªõi k√Ω 2025 ch∆∞a k√Ω 2026",
                    status2025: "M·ªõi k√Ω 2025",
                    status2026: "Ch∆∞a k√Ω 2026",
                    note: "",
                    imageUrl: data._imageUrl || ""
                };
            } else {
                return {
                    status: "old-2025-no-2026",
                    display: "‚ö†Ô∏è ƒê√£ k√Ω 2025 ch∆∞a k√Ω 2026",
                    status2025: "ƒê√£ k√Ω 2025",
                    status2026: "Ch∆∞a k√Ω 2026",
                    note: "",
                    imageUrl: data._imageUrl || ""
                };
            }
        } else {
            return {
                status: "pending-2026",
                display: "‚è≥ ƒê√£ k√Ω 2026 ch∆∞a duy·ªát",
                status2025: "ƒê√£ k√Ω 2025",
                status2026: "ƒê√£ k√Ω 2026 - CH∆ØA DUY·ªÜT",
                note: "",
                imageUrl: data._imageUrl || ""
            };
        }
    } else if (source === 'original') {
        return {
            status: "old-2025-no-2026",
            display: "‚ö†Ô∏è ƒê√£ k√Ω 2025 ch∆∞a k√Ω 2026",
            status2025: "ƒê√£ k√Ω 2025",
            status2026: "Ch∆∞a k√Ω 2026",
            note: "",
            imageUrl: ""
        };
    }
    
    return {
        status: "unknown",
        display: "‚ùì Kh√¥ng x√°c ƒë·ªãnh",
        status2025: "",
        status2026: "",
        note: "",
        imageUrl: ""
    };
}

async function loadData(useCache = true) {
    try {
        showMessage("‚è≥ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...");
        
        const [newResponse, oldResponse, updateResponse] = await Promise.all([
            fetch(NEW_URL + '&_=' + Date.now()),
            fetch(OLD_URL + '&_=' + Date.now()),
            fetch(UPDATE_URL + '&_=' + Date.now())
        ]);

        const newText = await newResponse.text();
        const oldText = await oldResponse.text();
        const updateText = await updateResponse.text();

        const newJson = parseGViz(newText);
        const oldJson = parseGViz(oldText);
        const updateJson = parseGViz(updateText);

        console.log("=== DEBUG INFO ===");
        console.log("New data rows:", newJson.table.rows.length);
        console.log("Old data rows:", oldJson.table.rows.length);
        console.log("Update data rows:", updateJson.table.rows.length);

        let latestUpdateDate = null;

        const newDataArray = [];
        newJson.table.rows.forEach(row => {
            const obj = rowToObject(newJson.table.cols, row);
            
            const maKH = normalizeValue(obj["M√£ KH"]);
            const sdt = normalizeValue(obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const kh = normalizeValue(obj["KH"]);
            const tdv = normalizeValue(obj["TDV"]);
            
            const imageUrlRaw = normalizeValue(
                obj["Link ·∫£nh"] ||
                obj["H√¨nh ·∫£nh"] ||
                obj[newJson.table.cols[13]?.label] ||
                ""
            );
            const imageUrl = extractImageUrl(imageUrlRaw);
            
            obj._search = [maKH, kh, sdt, tdv].join(" ").toLowerCase();
            obj._source = "new";
            obj._uniqueKey = createUniqueKey(kh, sdt);
            obj._ngayDate = null;
            obj._imageUrl = imageUrl;
            obj._formType = "FM2601";
            
            newDataArray.push(obj);
        });

        const oldDataArray = [];
        oldJson.table.rows.forEach(row => {
            const obj = rowToObject(oldJson.table.cols, row);
            
            const maKH = normalizeValue(obj["M√£ KH"]);
            const sdt = normalizeValue(obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const kh = normalizeValue(obj["KH"]);
            const tdv = normalizeValue(obj["TDV"]);
            
            obj._search = [maKH, kh, sdt, tdv].join(" ").toLowerCase();
            obj._source = "original";
            obj._uniqueKey = createUniqueKey(kh, sdt);
            obj._ngayDate = null;
            obj._imageUrl = "";
            obj._formType = "";
            
            oldDataArray.push(obj);
        });

        const updateDataArray = [];
        updateJson.table.rows.forEach(row => {
            const obj = rowToObject(updateJson.table.cols, row);
            
            const maKH = normalizeValue(obj["M√£ KH"]);
            const sdt = normalizeValue(obj["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
            const kh = normalizeValue(obj["KH"]);
            const tdv = normalizeValue(obj["TDV"]);
            const ngay = normalizeValue(obj["NGAY"]);
            
            const colA = normalizeValue(
                obj["C·ªôt A"] || 
                obj["Form"] || 
                obj["Lo·∫°i form"] ||
                obj[updateJson.table.cols[0]?.label] || 
                ""
            );
            
            const imageUrlRaw = normalizeValue(
                obj["Link ·∫£nh"] ||
                obj["H√¨nh ·∫£nh"] ||
                obj[updateJson.table.cols[13]?.label] ||
                ""
            );
            const imageUrl = extractImageUrl(imageUrlRaw);
            
            let formType = "";
            if (colA.includes("FM2601")) {
                formType = "FM2601";
            } else if (colA.includes("FM2501")) {
                formType = "FM2501";
            }
            
            const ngayDate = parseNgayColumn(ngay);
            
            // Track latest update date
            if (ngayDate && (!latestUpdateDate || ngayDate > latestUpdateDate)) {
                latestUpdateDate = ngayDate;
            }
            
            obj._search = [maKH, kh, sdt, tdv].join(" ").toLowerCase();
            obj._source = "bc_loyalty";
            obj._uniqueKey = createUniqueKey(kh, sdt);
            obj._ngayDate = ngayDate;
            obj._imageUrl = imageUrl;
            obj["C·ªôt A"] = colA;
            obj._formType = formType;
            obj._tdv = tdv;
            
            updateDataArray.push(obj);
        });

        const dataMap = new Map();
        const duplicateMap = new Map();
        
        oldDataArray.forEach(item => {
            if (item._uniqueKey) {
                dataMap.set(item._uniqueKey, item);
            }
        });
        
        // Group bc_loyalty records by unique key
        const bcLoyaltyByKey = new Map();
        updateDataArray.forEach(item => {
            if (item._uniqueKey) {
                if (!bcLoyaltyByKey.has(item._uniqueKey)) {
                    bcLoyaltyByKey.set(item._uniqueKey, []);
                }
                bcLoyaltyByKey.get(item._uniqueKey).push(item);
            }
        });
        
        // Process bc_loyalty records
        bcLoyaltyByKey.forEach((records, uniqueKey) => {
            if (records.length === 0) return;
            
            // Sort by date (newest first)
            records.sort((a, b) => {
                if (!a._ngayDate && !b._ngayDate) return 0;
                if (!a._ngayDate) return 1;
                if (!b._ngayDate) return -1;
                return b._ngayDate - a._ngayDate;
            });
            
            // Analyze all records to determine proper main record
            const newestRecord = records[0];
            const oldestRecord = records[records.length - 1];
            const newestTdv = newestRecord._tdv;
            const newestFormType = newestRecord._formType;
            
            let mainRecord = newestRecord; // Default to newest
            const uploadHistory = [];
            
            // Check relationships between records
            for (let i = 1; i < records.length; i++) {
                const olderRecord = records[i];
                const olderTdv = olderRecord._tdv;
                const olderFormType = olderRecord._formType;
                
                let isDuplicate = false;
                let reason = '';
                
                // Case 1: Same TDV, same form type -> Upload l·∫°i
                if (olderTdv === newestTdv && olderFormType === newestFormType) {
                    isDuplicate = false;
                    reason = 'upload l·∫°i';
                }
                // Case 2: Same TDV, different form type -> B·ªè qua (n√¢ng c·∫•p t·ª± nhi√™n)
                else if (olderTdv === newestTdv && olderFormType !== newestFormType) {
                    continue; // Skip this case entirely
                }
                // Case 3: Different TDV, same form type
                else if (olderTdv !== newestTdv && olderFormType === newestFormType) {
                    if (isSameTeam(olderTdv, newestTdv)) {
                        // Same team -> K√Ω ƒë√®
                        isDuplicate = false;
                        reason = 'k√Ω ƒë√®';
                        // For "k√Ω ƒë√®", we want the OLDER record as main
                        if (i === records.length - 1) {
                            // This is the oldest record, should be main
                            mainRecord = olderRecord;
                        }
                    } else {
                        // Different team -> K√Ω l·ªôn
                        isDuplicate = true;
                        reason = 'k√Ω l·ªôn';
                        // For "k√Ω l·ªôn", we want the OLDER (correct) record as main
                        mainRecord = olderRecord;
                    }
                }
                // Case 4: Different TDV, different form type
                else if (olderTdv !== newestTdv && olderFormType !== newestFormType) {
                    if (isSameTeam(olderTdv, newestTdv)) {
                        // Same team -> K√Ω ƒë√®
                        isDuplicate = false;
                        reason = 'k√Ω ƒë√®';
                        // For "k√Ω ƒë√®", we want the OLDER record as main
                        if (i === records.length - 1) {
                            mainRecord = olderRecord;
                        }
                    } else {
                        // Different team -> K√Ω l·ªôn
                        isDuplicate = true;
                        reason = 'k√Ω l·ªôn';
                        // For "k√Ω l·ªôn", we want the OLDER (correct) record as main
                        mainRecord = olderRecord;
                    }
                }
                
                uploadHistory.push({
                    tdv: olderTdv,
                    imageUrl: olderRecord._imageUrl,
                    date: olderRecord._ngayDate,
                    formType: olderFormType,
                    reason: reason,
                    isDuplicate: isDuplicate,
                    record: olderRecord
                });
            }
            
            // Now build the history relative to the main record
            const finalHistory = [];
            
            for (const record of records) {
                if (record === mainRecord) continue;
                
                const recordTdv = record._tdv;
                const recordFormType = record._formType;
                const mainTdv = mainRecord._tdv;
                const mainFormType = mainRecord._formType;
                
                let isDuplicate = false;
                let reason = '';
                
                // Same TDV, same form -> upload l·∫°i
                if (recordTdv === mainTdv && recordFormType === mainFormType) {
                    isDuplicate = false;
                    reason = 'upload l·∫°i';
                }
                // Same TDV, different form -> Skip
                else if (recordTdv === mainTdv && recordFormType !== mainFormType) {
                    continue;
                }
                // Different TDV, same team
                else if (recordTdv !== mainTdv && isSameTeam(recordTdv, mainTdv)) {
                    isDuplicate = false;
                    reason = 'k√Ω ƒë√®';
                }
                // Different TDV, different team
                else if (recordTdv !== mainTdv && !isSameTeam(recordTdv, mainTdv)) {
                    isDuplicate = true;
                    reason = 'k√Ω l·ªôn';
                }
                
                finalHistory.push({
                    tdv: recordTdv,
                    imageUrl: record._imageUrl,
                    date: record._ngayDate,
                    formType: recordFormType,
                    reason: reason,
                    isDuplicate: isDuplicate
                });
            }
            
            // Filter duplicates for warnings
            const duplicates = finalHistory.filter(item => item.isDuplicate);
            
            if (duplicates.length > 0) {
                mainRecord._duplicates = duplicates;
            }
            
            // Store full history
            if (finalHistory.length > 0) {
                mainRecord._uploadHistory = finalHistory;
            }
            
            dataMap.set(uniqueKey, mainRecord);
        });
        
        newDataArray.forEach(item => {
            if (item._uniqueKey) {
                dataMap.set(item._uniqueKey, item);
            }
        });
        
        uniqueData = Array.from(dataMap.values());
        
        allProvinces = new Set();
        uniqueData.forEach(item => {
            const tinh = normalizeValue(item["T·ªânh"]);
            if (tinh) {
                allProvinces.add(tinh);
            }
        });
        
        populateProvinceFilter();
        
        // Update the time display
        if (latestUpdateDate) {
            const updateTimeEl = document.getElementById("updateTime");
            updateTimeEl.textContent = `Updated t·ªõi ng√†y: ${formatUpdateTime(latestUpdateDate)}`;
        }
        
        const totalRaw = newDataArray.length + oldDataArray.length + updateDataArray.length;
        console.log("Total raw data:", totalRaw);
        console.log("Unique data after deduplication:", uniqueData.length);
        console.log("Duplicates removed:", totalRaw - uniqueData.length);

        isLoading = false;
        showMessage(`‚úÖ ƒê√£ t·∫£i ${uniqueData.length} kh√°ch h√†ng duy nh·∫•t (t·ª´ ${newDataArray.length} new + ${updateDataArray.length} bc_loyalty + ${oldDataArray.length} old). H√£y nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm.`);
        
    } catch (error) {
        isLoading = false;
        showMessage("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.");
        console.error("Load error:", error);
    }
}

function populateProvinceFilter() {
    const select = document.getElementById("provinceFilter");
    const sortedProvinces = Array.from(allProvinces).sort();
    
    select.innerHTML = '<option value="all">-- T·∫•t c·∫£ t·ªânh th√†nh --</option>';
    
    sortedProvinces.forEach(province => {
        const option = document.createElement("option");
        option.value = province;
        option.textContent = province;
        select.appendChild(option);
    });
}

function render(keyword = "") {
    const tbody = document.getElementById("tbody");
    const statsDiv = document.getElementById("stats");
    
    if (isLoading) {
        return;
    }

    if (!keyword.trim()) {
        tbody.innerHTML = '<tr><td colspan="9" class="no-results">üëÜ Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm</td></tr>';
        statsDiv.style.display = "none";
        return;
    }

    const kw = keyword.toLowerCase().trim();
    const fragment = document.createDocumentFragment();
    let count = 0;
    
    const stats = {
        'approved-2026': 0,
        'pending-2026': 0,
        'error-2026': 0,
        'new-2025-only': 0,
        'old-2025-no-2026': 0
    };

    for (const data of uniqueData) {
        if (!data._search.includes(kw)) continue;

        const statusInfo = determineCustomerStatus(data, uniqueData);
        const tinh = normalizeValue(data["T·ªânh"]);
        
        if (currentFilter !== 'all' && statusInfo.status !== currentFilter) continue;
        
        if (currentProvince !== 'all' && tinh !== currentProvince) continue;

        const tr = document.createElement("tr");
        tr.className = statusInfo.status;
        
        stats[statusInfo.status]++;

        const maKH = normalizeValue(data["M√£ KH"]);
        const sdt = normalizeValue(data["S·ªë ƒëi·ªán tho·∫°i di ƒë·ªông"]);
        const khachHang = normalizeValue(data["KH"]);
        const tdvName = normalizeValue(data["TDV"]);
        const imageUrl = statusInfo.imageUrl;
        
        let noteHTML = statusInfo.note;
        
        // Display duplicates (k√Ω l·ªôn warnings)
        if (data._duplicates && data._duplicates.length > 0) {
            const dupWarnings = data._duplicates.map(dup => {
                const dupUrl = dup.imageUrl || '';
                const dupTdv = dup.tdv || 'Unknown';
                const dupFormType = dup.formType || '';
                const reason = dup.reason || 'k√Ω l·ªôn';
                if (dupUrl) {
                    return `<span class="duplicate-warning" onclick="openImageModal('${dupUrl}', '${khachHang}')" title="Click ƒë·ªÉ xem ·∫£nh">‚ö†Ô∏è ${dupTdv} ${reason} (${dupFormType})</span>`;
                } else {
                    return `<span class="duplicate-warning">‚ö†Ô∏è ${dupTdv} ${reason} (${dupFormType})</span>`;
                }
            }).join('<br>');
            
            if (noteHTML) {
                noteHTML += '<br>' + dupWarnings;
            } else {
                noteHTML = dupWarnings;
            }
        }
        
        // Display upload history (non-duplicate uploads like "upload l·∫°i", "n√¢ng c·∫•p")
        if (data._uploadHistory && data._uploadHistory.length > 0) {
            const nonDuplicates = data._uploadHistory.filter(item => !item.isDuplicate);
            if (nonDuplicates.length > 0) {
                const historyInfo = nonDuplicates.map(item => {
                    const histUrl = item.imageUrl || '';
                    const histTdv = item.tdv || 'Unknown';
                    const histFormType = item.formType || '';
                    const histReason = item.reason || 'upload tr∆∞·ªõc';
                    if (histUrl) {
                        return `<span class="upload-history" onclick="openImageModal('${histUrl}', '${khachHang}')" title="Click ƒë·ªÉ xem ·∫£nh">‚ÑπÔ∏è ${histTdv} ${histReason} (${histFormType})</span>`;
                    } else {
                        return `<span class="upload-history">‚ÑπÔ∏è ${histTdv} ${histReason} (${histFormType})</span>`;
                    }
                }).join('<br>');
                
                if (noteHTML) {
                    noteHTML += '<br>' + historyInfo;
                } else {
                    noteHTML = historyInfo;
                }
            }
        }
        
        const statusCellClass = imageUrl ? 'clickable-status' : '';
        const statusCellOnClick = imageUrl ? `onclick="openImageModal('${imageUrl}', '${khachHang}')"` : '';

        tr.innerHTML = `
            <td>${maKH}</td>
            <td>${khachHang}</td>
            <td>${tinh}</td>
            <td>${sdt}</td>
            <td>${tdvName}</td>
            <td>${statusInfo.status2025}</td>
            <td>${statusInfo.status2026}</td>
            <td>${noteHTML}</td>
            <td class="status-${statusInfo.status.replace(/-/g, '-')} ${statusCellClass}" ${statusCellOnClick} title="${imageUrl ? 'Click ƒë·ªÉ xem h√¨nh ·∫£nh' : ''}">${statusInfo.display}</td>
        `;

        fragment.appendChild(tr);
        count++;
        
        if (count >= MAX_RENDER) break;
    }

    if (count === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="no-results">üîç Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</td></tr>';
        statsDiv.style.display = "none";
    } else {
        tbody.innerHTML = "";
        tbody.appendChild(fragment);
        
        const filterText = currentFilter === 'all' ? '' : ` (L·ªçc: ${document.querySelector(`label[for="status-${currentFilter.split('-')[0]}"]`)?.textContent || ''})`;
        const provinceText = currentProvince !== 'all' ? ` - T·ªânh: ${currentProvince}` : '';
        
        statsDiv.innerHTML = `
            üìä T√¨m th·∫•y <strong>${count}</strong> k·∫øt qu·∫£${filterText}${provinceText}<br>
            ‚úÖ ƒê√£ k√Ω 2026 & Duy·ªát: <strong>${stats['approved-2026']}</strong> | 
            ‚è≥ ƒê√£ k√Ω 2026 ch∆∞a duy·ªát: <strong>${stats['pending-2026']}</strong> | 
            ‚ùå ƒê√£ k√Ω 2026 b·ªã l·ªói: <strong>${stats['error-2026']}</strong><br>
            üÜï M·ªõi k√Ω 2025: <strong>${stats['new-2025-only']}</strong> | 
            ‚ö†Ô∏è ƒê√£ k√Ω 2025 ch∆∞a k√Ω 2026: <strong>${stats['old-2025-no-2026']}</strong>
            ${count >= MAX_RENDER ? ` (Hi·ªÉn th·ªã t·ªëi ƒëa ${MAX_RENDER} k·∫øt qu·∫£)` : ''}
        `;
        statsDiv.style.display = "block";
    }
}

function showMessage(msg) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = `<tr><td colspan="9" class="loading">${msg}</td></tr>`;
}

document.getElementById("searchInput").addEventListener("input", e => {
    clearTimeout(debounceTimer);
    const value = e.target.value;
    debounceTimer = setTimeout(() => render(value), 250);
});

document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
    radio.addEventListener('change', e => {
        currentFilter = e.target.value;
        const keyword = document.getElementById("searchInput").value;
        render(keyword);
    });
});

document.getElementById("provinceFilter").addEventListener('change', e => {
    currentProvince = e.target.value;
    const keyword = document.getElementById("searchInput").value;
    render(keyword);
});

document.getElementById("clearFilters").addEventListener('click', () => {
    document.getElementById("status-all").checked = true;
    currentFilter = 'all';
    
    document.getElementById("provinceFilter").value = 'all';
    currentProvince = 'all';
    
    document.getElementById("searchInput").value = '';
    
    render('');
});

document.getElementById("clearCache").addEventListener('click', () => {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi?')) {
        isLoading = true;
        uniqueData = [];
        showMessage("‚è≥ ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...");
        setTimeout(() => {
            loadData(false);
        }, 100);
    }
});

document.getElementById("searchInput").focus();

loadData();
</script>

</body>
</html>
